---
# tasks file for hswong3i.gluster_volume_volume

- name: create a LV to serve as the metadata device from VG
  lvol:
    vg: "gluster-volumes"
    lv: "meta-{{ item.name }}"
    size: "16G"
  with_items: "{{ gluster_volume }}"
  tags: hswong3i.gluster_volume

- name: create a LV to serve as the data device from VG
  lvol:
    vg: "gluster-volumes"
    lv: "pool-{{ item.name }}"
    size: "{{ item.size }}"
  with_items: "{{ gluster_volume }}"
  tags: hswong3i.gluster_volume

- name: create a thin poll from the data LV and metadata LV
  shell: |
    lvconvert -y --chunksize 1280K --thinpool gluster-volumes/pool-{{ item.name }} --poolmetadata gluster-volumes/meta-{{ item.name }}
  with_items: "{{ gluster_volume }}"
  ignore_errors: yes
  tags: hswong3i.gluster_volume

- name: zeroed the thin poll to prevent data leaking between different block devices
  shell: |
    lvchange --zero n gluster-volumes/pool-{{ item.name }}
  with_items: "{{ gluster_volume }}"
  ignore_errors: yes
  tags: hswong3i.gluster_volume

- name: create LV from VG
  shell: |
    lvcreate -V {{ item.size }} -T gluster-volumes/pool-{{ item.name }} -n volume-{{ item.name }}
  with_items: "{{ gluster_volume }}"
  ignore_errors: yes
  tags: hswong3i.gluster_volume

- name: format LV with xfs
  filesystem:
    dev: "/dev/gluster-volumes/volume-{{ item.name }}"
    fstype: "xfs"
    opts: "-f -i size=512 -n size=8192 -d su=128k,sw=10"
  with_items: "{{ gluster_volume }}"
  tags: hswong3i.gluster_volume

- name: mount LV as brick
  mount:
    name: "/srv/gluster/{{ item.name }}"
    src: "/dev/gluster-volumes/volume-{{ item.name }}"
    fstype: "xfs"
    opts: "defaults,inode64,noatime,nouuid"
    state: "mounted"
  with_items: "{{ gluster_volume }}"
  tags: hswong3i.gluster_volume

- name: create brick folder
  file:
    dest: "/srv/gluster/{{ item.name }}/brick"
    owner: "root"
    group: "root"
    mode: "0755"
    state: "directory"
  with_items: "{{ gluster_volume }}"
  tags: hswong3i.gluster_volume

- name: gluster volume create
  gluster_volume:
    name: "{{ item.name }}"
    bricks: "/srv/gluster/{{ item.name }}/brick"
    host: "{{ inventory_hostname }}"
    cluster: "{{ play_hosts | join(',') }}"
    replicas: "{{ item.replicas | default(None) or omit }}"
    stripes: "{{ item.stripes | default(None) or omit }}"
    disperses: "{{ item.disperses | default(None) or omit }}"
    redundancies: "{{ item.redundancies | default(None) or omit }}"
    start_on_create: "no"
    state: "present"
  with_items: "{{ gluster_volume }}"
  when: play_hosts | length > 1
  run_once: yes
  tags: hswong3i.gluster_volume

- name: gluster volume set
  gluster_volume:
    name: "{{ item.name }}"
    bricks: "/srv/gluster/{{ item.name }}/brick"
    host: "{{ inventory_hostname }}"
    cluster: "{{ play_hosts | join(',') }}"
    options: "{{ item.options | default(None) or omit }}"
    state: "present"
  with_items: "{{ gluster_volume }}"
  when: play_hosts | length > 1
  run_once: yes
  tags: hswong3i.gluster_volume

- name: gluster volume start
  gluster_volume:
    name: "{{ item.name }}"
    state: "started"
  with_items: "{{ gluster_volume }}"
  when: play_hosts | length > 1
  run_once: yes
  tags: hswong3i.gluster_volume

- name: mount -t glusterfs
  mount:
    src: "localhost:{{ item.name }}"
    name: "/mnt/gluster/{{ item.name }}"
    fstype: "glusterfs"
    opts: "defaults,_netdev"
    state: "mounted"
  with_items: "{{ gluster_volume }}"
  when: play_hosts | length > 1
  tags: hswong3i.gluster_volume
